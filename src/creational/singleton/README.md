# Одиночка

> Шаблон проектирования, который многие ненавидят… но действительно ли он так плох?

![builder.png](../_images/singleton.png)

[Source](https://refactoring.guru/design-patterns/singleton)

---

## Описание

Одиночка (Singleton) – компонент (класс), экземпляр которого создаётся только один раз.

---

## Мотивация

- Для некоторых компонентов имеет смысл иметь только один такой компонент в системе
    - Хранилище базы данных
    - Фабрика объектов
- Например, вызов конструктора стоит дорого
    - Мы делаем это только один раз
    - Предоставляем всем одинаковых экземпляр
- Мы хотим запретить кому бы то ни было создавать дополнительные копии
- Нужно позаботиться о ленивом создании экземпляра

---

## Реализация

- [SimpleSingleton](SimpleSingleton.java)
- [LazySingleton](LazySingleton.java)
- [SyncAccessorSingleton](SyncAccessorSingleton.java)
- [DoubleCheckedLockingSingleton](DoubleCheckedLockingSingleton.java)
- [ClassHolderSingleton](ClassHolderSingleton.java)
- [EnumSingleton](EnumSingleton.java)

---

## Заключение

- Различные реализации `Singleton` (Одиночки):
    - Simple Solution
    - Lazy Initialization
    - Synchronized Accessor
    - Double-Checked Locking
    - Class Holder Singleton
    - Enum Singleton
- Ленивая реализация – это просто, инициализируем объект только по первому запросу
- Проблемы с тестируемостью

| За                                                             | Против                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|----------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Вы можете быть уверены, что класс имеет только один экземпляр. | Нарушает принцип единой ответственности. Паттерн решает одновременно две проблемы                                                                                                                                                                                                                                                                                                                                                              |
| Вы получаете глобальную точку доступа к этому экземпляру.      | Шаблон `Singleton` может маскировать плохой дизайн, например, когда компоненты программы слишком много знают друг о друге.                                                                                                                                                                                                                                                                                                                     |
| Объект инициализируется только при первом запросе.             | Шаблон требует специальной обработки в многопоточной среде, чтобы несколько потоков не создавали одиночный объект несколько раз.                                                                                                                                                                                                                                                                                                               |
| -                                                              | Модульное тестирование клиентского кода `Singleton` может быть затруднено, поскольку многие среды тестирования полагаются на наследование при создании фиктивных объектов. Поскольку конструктор класса-одиночки является закрытым и переопределение статических методов невозможно в большинстве языков, вам нужно будет придумать творческий способ имитировать синглтон. Или просто не пишите тесты. Или не используйте шаблон `Singleton`. |

> - Когда авторы книги «Банда четырех» встретились 10 лет спустя, чтобы обсудить шаблоны проектирования,
    они затронули тему от каких из них можно было бы отказаться. И они решили, что им нравятся все шаблоны
    проектирования кроме, наверное, _Одиночки_.
> > «Осуждая, какие паттерны исключить, мы решили, что по-прежнему любим их все.
> > (Но не совсем – я бы отказался от Одиночки. Его использование почти всегда приводит к плохому коду.» Эрих Гамма

---

| № | Реализация                                                   | Ленивая инициализация | Потокобезопасность | Скорость работы при многопоточности | Когда использовать?                                                                                                         |
|---|--------------------------------------------------------------|-----------------------|--------------------|-------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| 1 | [Simple Solution](SimpleSingleton.java)                      | -                     | +                  | Быстро                              | Никогда. Либо когда не важна ленивая инициализация. Но лучше никогда.                                                       |
| 2 | [Lazy Initialization](LazySingleton.java)                    | +                     | -                  | Неприменимо                         | Всегда, когда не нужна многопоточность                                                                                      |
| 3 | [Synchronized Accessor](SyncAccessorSingleton.java)          | +                     | +                  | Медленно                            | Никогда. Либо когда скорость работы при многопоточности не имеет значения. Но лучше никогда.                                |
| 4 | [Double-Checked Locking](DoubleCheckedLockingSingleton.java) | +                     | +                  | Быстро                              | В редких случаях, когда нужно обрабатывать исключения при создании `Singleton`. (когда неприменим `Class Holder Singleton`) |
| 5 | [Class Holder Singleton](ClassHolderSingleton.java)          | +                     | +                  | Быстро                              | Всегда, когда нужна многопоточность и есть гарантия, что объект `Singleton` класса будет создан без проблем.                |
| 6 | [Enum Singleton](EnumSingleton.java)                         | +                     | +                  | Быстро                              | Всегда, когда требуется простая, надежная и безопасная реализация `Singleton` без необходимости наследования.               |

---

## Полезные ресурсы

- [Паттерны проектирования: Singleton](https://javarush.com/groups/posts/2365-patternih-proektirovanija-singleton)
- [Правильный Singleton в Java](https://habr.com/ru/articles/129494/)
- [Singleton Pattern](https://www.oodesign.com/singleton-pattern)
